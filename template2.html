<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>QR Scan (BarcodeDetector only)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 16px; display: grid; gap: 12px; }
    h1 { margin: 0 0 8px; font-size: 18px; }
    #controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status { padding: 10px; background: #f6f6f6; border-radius: 8px; min-height: 2.2em; }
    #videoWrap {
      position: relative; max-width: 480px; width: 100%; border-radius: 12px; overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
    }
    video { width: 100%; height: auto; display: block; transform: scaleX(-1); } /* зеркалим для удобства */
    #overlay {
      position: absolute; inset: 0; pointer-events: none; border: 2px dashed rgba(255,255,255,.6);
      border-radius: 12px;
    }
    .small { color: #666; font-size: 12px; }
    code { background: #eee; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>QR сканер (только BarcodeDetector)</h1>

  <div id="controls">
    <button id="startBtn">Запустить камеру</button>
    <button id="stopBtn" disabled>Остановить</button>
    <span class="small">Требуется HTTPS. Поддерживаются Android Chrome и iOS Safari.</span>
  </div>

  <div id="videoWrap" hidden>
    <video id="video" playsinline muted></video>
    <div id="overlay"></div>
  </div>

  <div id="status">Готово к сканированию.</div>

  <script type="module">
    /** @type {HTMLButtonElement} */ const startBtn = document.getElementById('startBtn');
    /** @type {HTMLButtonElement} */ const stopBtn  = document.getElementById('stopBtn');
    /** @type {HTMLDivElement}   */ const statusEl = document.getElementById('status');
    /** @type {HTMLVideoElement} */ const video    = document.getElementById('video');
    /** @type {HTMLDivElement}   */ const videoWrap= document.getElementById('videoWrap');

    let stream /** @type {MediaStream|null} */ = null;
    let rafId  /** @type {number|undefined} */ = undefined;
    let detector /** @type {any} */ = null;
    let lastText = '';

    // Проверка поддержки только один раз
    async function ensureSupport() {
      if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Доступ к камере не поддерживается в этом браузере.');
      }
      if (!('BarcodeDetector' in window)) {
        throw new Error('BarcodeDetector недоступен. Откройте в Chrome (Android) или Safari (iOS), либо обновите браузер.');
      }
      // Некоторые движки требуют запросить поддерживаемые форматы заранее
      // @ts-ignore
      const formats = await BarcodeDetector.getSupportedFormats?.() ?? [];
      if (formats.length && !formats.includes('qr_code')) {
        throw new Error('Этот браузер не поддерживает формат QR в BarcodeDetector.');
      }
    }

    function setUI(running) {
      startBtn.disabled = running;
      stopBtn.disabled = !running;
      videoWrap.hidden = !running;
    }

    function stop() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = undefined;
      if (stream) {
        for (const track of stream.getVideoTracks()) track.stop();
        stream = null;
      }
      setUI(false);
    }

    async function start() {
      try {
        await ensureSupport();

        // Захват камеры (стараемся взять заднюю)
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 }, height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();

        // Инициализируем детектор только для QR
        // @ts-ignore
        detector = new BarcodeDetector({ formats: ['qr_code'] });

        setUI(true);
        status('Сканирую… наведите камеру на QR.');
        lastText = '';

        loop(); // поехали
      } catch (err) {
        stop();
        status('Ошибка: ' + (err?.message || err));
      }
    }

    async function loop() {
      try {
        // В некоторых браузерах detect(video) работает напрямую (video — валидный ImageBitmapSource)
        const results = await detector.detect(video);
        if (results && results.length) {
          const text = results[0].rawValue || '';
          if (text && text !== lastText) {
            lastText = text;
            status('Найден QR: ' + escapeHtml(text));
            // Немного «паузы», чтобы не спамить
            await sleep(500);
          }
        }
      } catch (e) {
        // Тихо игнорируем редкие кадры с ошибкой, но не глушим цикл
      }
      rafId = requestAnimationFrame(loop);
    }

    function status(msg) { statusEl.textContent = msg; }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, ch =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])
      );
    }

    startBtn.addEventListener('click', start, { passive: true });
    stopBtn.addEventListener('click', stop,  { passive: true });

    // Останавливаем камеру при уходе со страницы
    window.addEventListener('pagehide', stop);
    window.addEventListener('visibilitychange', () => {
      if (document.hidden) stop();
    });
  </script>
</body>
</html>
